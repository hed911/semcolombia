# encoding: UTF-8

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
<%= javascript_include_tag "l.control.geosearch" %>
<%= javascript_include_tag "l.geosearch.provider.google" %>
<%= javascript_include_tag "l.geosearch.provider.openstreetmap" %>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

<script src="https://unpkg.com/esri-leaflet@2.0.4"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet-geocoder/2.2.1/esri-leaflet-geocoder.css">
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet-geocoder@2.2.1/dist/esri-leaflet-geocoder-debug.min.js"></script>

</br>
<h3>RESUMEN:</h3>
<h4 class="<%= @municipio.usuarios.count == 0 ? 'error-label' : '' %>">Usuarios <%= @municipio.usuarios.count %></h4>
<h4 class="<%= @municipio.institucions.count == 0 ? 'error-label' : '' %>">Hospitales <%= @municipio.institucions.count %></h4>
<h4 class="<%= @municipio.empresa_ambulancias.count == 0 ? 'error-label' : '' %>">Empresas Ambulancias <%= @municipio.empresa_ambulancias.count %></h4>
<h4 class="<%= @municipio.ambulancias.count == 0 ? 'error-label' : '' %>">Ambulancias <%= @municipio.ambulancias.count %></h4>
<% if @municipio.zonas.any? -%>
	<h4>Cobertura ESTABLECIDA</h4>
<% else -%>
	<h4 class="error-label">Cobertura NO ESTABLECIDA</h4>
<% end -%>
<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#add-usuario">
	Nuevo Usuario
</button>

<button onclick="open_editar_cobertura_modal(<%= @municipio.id %>);" type="button" class="btn btn-primary btn-lg active">Editar Cobertura</button>

<%= link_to toggle_habilitacion_remision_municipio_path(@municipio.id), :method => "put", :class => (@municipio.habilitado_remisiones == true ? "btn btn-primary btn-lg" : "btn btn-danger btn-lg"), :title => "Habilitar/Deshabilitar que acepte remisiones" do %>
	<%= @municipio.habilitado_remisiones == true ? "Deshabilitar Remisiones" : "Habilitar Remisiones" %>
<% end %>

<%= link_to toggle_habilitacion_autorizacion_municipio_path(@municipio.id), :method => "put", :class => (@municipio.habilitado_autorizaciones == true ? "btn btn-primary btn-lg" : "btn btn-danger btn-lg"), :title => "Habilitar/Deshabilitar que acepte autorizaciones" do %>
	<%= @municipio.habilitado_autorizaciones == true ? "Deshabilitar Autorizaciones" : "Habilitar Autorizaciones" %>
<% end %>

<h1>Usuarios <%= @municipio.nombre %></h1>
<%= form_tag(export_xls_municipio_usuarios_path(@municipio.id), method: "post",  :multipart => true, "data-ajax" => "false" ) do %>

	<div class="panel panel-danger">
		<div class="panel-heading">
			<h3 class="panel-title"></h3>
		</div>
		<div class="panel-body">
			<div class="table-responsive">
				<table id="table-result" class="table table-bordered table-hover table-striped tablesorter">
				  <thead>
				    <tr>
	            <th data-sort="int">#</th>
				      <th data-sort="string">Nombre Completo</th>
	            <th data-sort="string">Identificacion</th>
							<th data-sort="string">Email</th>
							<th data-sort="string">Telefono</th>
	            <th data-sort="string">Cargo</th>
	            <th data-sort="string">Fecha Vigencia</th>
							<th data-sort="string">Roles</th>
				      <th>Acción</th>
				    </tr>
				  </thead>
				  <tbody id="table-result-body">
				  	<% count = 0 -%>
						<% @usuarios.each do |usuario| -%>
							<% count += 1 -%>
							<tr class="<%= (usuario.activo) ? 'success' : 'danger' %>">
									<% if usuario.activo -%>
										<td><i class="fa fa-check-circle"></i><%= count %></td>
									<% else -%>
										<td><i style="color:red;" class="fa fa-times"></i><%= count %></td>
									<% end -%>
									<td><%= usuario.nombre_completo %></td>
							    <td><%= usuario.identificacion %></td>
	                <td><%= usuario.email %></td>
									<td><%= usuario.telefono %></td>
	                <td><%= usuario.cargo %></td>
									<td><%= usuario.fecha_vigencia.strftime("%e %b %Y") if usuario.fecha_vigencia %></td>
									<td><%= usuario.roles_value %></td>
									<td>

										<%= link_to municipio_usuario_path(:id => usuario.id, :municipio_id => @municipio.id), method: :delete, title:"Borrar", :class => "btn btn-default", :data => { :confirm => 'Estas seguro? Este cambio no se puede revertir' } do %>
	                    <i class="fa fa-trash-o"></i> Borrar
									  <% end %>

										<%= link_to reset_password_municipio_usuario_path(:id => usuario.id, :municipio_id => @municipio.id), method: :patch, :class => "btn btn-default", :title => "Restablecer Contraseña" do %>
											<i class="fa fa-unlock-alt" aria-hidden="true"></i> Restablecer Contraseña
									  <% end %>

									</td>
							</tr>
						<% end -%>
				  </tbody>
				</table>
			</div>
		</div>
	</div>

	<%= submit_tag "✓Exportar Datos", :name => 'export_data' %>
<% end %>
<div id="modal">
</div>


<!-- ==========-=-=-=-=-=-=-=-=-=-= MODAL AGREGAR USUARIO =-=-=-=-=-=-=-=-=-=-========== -->
	<div class="modal fade" id="add-usuario" tabindex="-1" role="dialog" aria-labelledby="add-edit-Label" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	        <h4 class="modal-title text-center" id="add-table-Label">Nuevo Usuario</h4>
	      </div>
	      <div class="modal-body">
	        <%= form_tag(municipio_usuarios_path(@municipio), method: "post",  :multipart => true, "data-ajax" => "false" ) do %>

	          <div class="row">

							<div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Primer Nombre<p>
	                <%= text_field_tag(:primer_nombre, "", :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Segundo Nombre<p>
	                <%= text_field_tag(:segundo_nombre, "", :class =>"form-control", :placeholder => "") %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Primer Apellido<p>
	                <%= text_field_tag(:primer_apellido, "", :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Segundo Apellido<p>
	                <%= text_field_tag(:segundo_apellido, "", :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

							<div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Telefono<p>
	                <%= text_field_tag(:telefono, "", :class =>"form-control", :placeholder => "") %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Identificacion<p>
	                <%= text_field_tag(:identificacion, "", :class =>"form-control", :placeholder => "") %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Email<p>
	                <%= text_field_tag(:email, "", :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

							<div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Password Dinamica<p>
	                <%= check_box_tag :password_dinamica, 'true', true, onchange:"passwordDinamicaChanged();", class:'form-control' %>
	              </div>
	            </div>

              <div id="password_container" class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Contraseña<p>
	                <%= password_field_tag(:password, "", :minlength => 8, :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

              <div id="repeat_password_container" class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Repita Contraseña<p>
	                <%= password_field_tag(:repeat_password, "", :minlength => 8, :class =>"form-control", :placeholder => "", :required => true) %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Cargo<p>
	                <%= text_field_tag(:cargo, "", :class =>"form-control", :placeholder => "") %>
	              </div>
	            </div>

              <div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Fecha Vigencia<p>
	                <%= date_field_tag(:fecha_vigencia, "", :class =>"form-control", :placeholder => "") %>
	              </div>
	            </div>

							<div class="col-md-12">
	              <div class="form-group">
	                <p class="control-label">Notificar por Correo<p>
	                <%= check_box_tag(:envio_correo, "", :class =>"form-control") %>
	              </div>
	            </div>

	            <div class="col-md-12">
	              <div class="form-group">
									<%= submit_tag "Crear", :class => "btn btn-default form-control" %>
	              </div>
	            </div>

	          </div>

	        <% end %>

	      </div>
	    </div>
	  </div>
	</div>
<!-- =-=-=-=-=-=-=-=-=-=-========== /MODAL AGREGAR USUARIO ==========-=-=-=-=-=-=-=-=-=-= -->


<script>
	function open_editar_cobertura_modal(id){
		$.get("/municipios/" + id + '/edit_cobertura',
			{
			},function(result){
				$('#modal').empty();
				$('#modal').append($.parseHTML( result ));
				$("#edit-cobertura").modal('show');
				init_mapa_interno();
		}, "text");
	}
	var polygons = [];
  var editableLayers = null;
	var mymap_interno = null;
	var googleGeocodeProvider = new L.GeoSearch.Provider.Google(),
			 addressText = '';
  var geocodeService = L.esri.Geocoding.geocodeService();
	var zonas_json = <%= @zonas_json.html_safe %>;
	function init_mapa_interno(){
		mymap_interno = L.map('map_interno', {
         fullscreenControl: true,
         fullscreenControl: {
           pseudoFullscreen: false
         }
    }).setView([<%= "#{@selected_city_point[0]}, #{@selected_city_point[1]}" %>], 16);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
			maxZoom: 18,
			id: 'hedu911.22cnjci9', //'your.mapbox.project.id',
			accessToken: 'pk.eyJ1IjoiaGVkdTkxMSIsImEiOiJjaXY5cTlwaWEwMGpoMnptODgzMjE4MDF3In0.lvUD1nWuzyTqt5KspZhHug'
	  }).addTo(mymap_interno);

		editableLayers = new L.FeatureGroup();
		mymap_interno.addLayer(editableLayers);

		var options = {
		   position: 'topright',
		   draw: {
		       polyline: false,
		       polygon: {
		           allowIntersection: true,
		           showArea: true
		           /*drawError: {
		               color: 'red', // Color the shape will turn when intersects
		               message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
		           },
		           shapeOptions: {
		               color: '#bada55'
		           }*/
		       },
		       circle: false,
		       rectangle: false
		   },
		   edit: {
		       featureGroup: editableLayers, //REQUIRED!!
		       remove: true
		   }
		};

		var drawControl = new L.Control.Draw(options);
		mymap_interno.addControl(drawControl);

		mymap_interno.on(L.Draw.Event.CREATED, function (e) {
		   var type = e.layerType,
		       layer = e.layer;
		   if (type === 'marker') {
		       layer.bindPopup('A popup!');
		   }
		   editableLayers.addLayer(layer);
			 updateHiddenField();
		});

		mymap_interno.on(L.Draw.Event.EDITED, function (e) {
		   updateHiddenField();
		});

		mymap_interno.on(L.Draw.Event.DELETED, function (e) {
		   updateHiddenField();
		});

		for(var i = 0; i < zonas_json.length; i++){
			polygons.push(new L.Polygon(zonas_json[i].puntos));
			polygons[i].editing.enable();
			editableLayers.addLayer(polygons[i]);
    }

		var new_zones = [];
    for(var i = 0; i < editableLayers.toGeoJSON().features.length; i++){
      new_zones.push(editableLayers.toGeoJSON().features[i].geometry.coordinates[0]);
    }

		$('#edit-cobertura').on('shown.bs.modal', function (e) {
			setTimeout(function() {
		    mymap_interno.invalidateSize();
		  }, 10);
		});
	}

	function updateHiddenField(){
		var new_zones = [];
    for(var i = 0; i < editableLayers.toGeoJSON().features.length; i++){
      new_zones.push(editableLayers.toGeoJSON().features[i].geometry.coordinates[0]);
    }
		$('#zonas').val(JSON.stringify(new_zones));
	}

	$('#add-usuario').on('shown.bs.modal', function (e) {
		$("#password_container").hide();
		$("#repeat_password_container").hide();
		$("#password").removeAttr('required');
		$("#repeat_password").removeAttr('required');
	});

	function passwordDinamicaChanged(){
		if(!$('#password_dinamica').is(":checked")){
			$("#password_container").show();
			$("#repeat_password_container").show();
			$("#password").attr('required','');
			$("#repeat_password").attr('required','');
		}
		else{
			$("#password_container").hide();
			$("#repeat_password_container").hide();
			$("#password").removeAttr('required');
			$("#repeat_password").removeAttr('required');
		}
	}

</script>
